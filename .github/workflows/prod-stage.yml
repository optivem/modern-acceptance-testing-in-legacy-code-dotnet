name: Production Stage

on:
  workflow_dispatch:
    inputs:
      prerelease-version:
        description: 'Prerelease version to promote (e.g., 1.2.3-alpha.1)'
        required: true
        type: string

jobs:
  promote-to-production:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify QA signoff
        run: |
          SIGNOFF_TAG="qa-signoff-${{ inputs.prerelease-version }}"
          SIGNOFF_EXISTS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$SIGNOFF_TAG")
          
          if [ "$SIGNOFF_EXISTS" != "200" ]; then
            echo "Error: QA signoff release $SIGNOFF_TAG does not exist"
            exit 1
          fi
          
          # Check if signoff was successful
          SIGNOFF_NAME=$(curl -s \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$SIGNOFF_TAG" | \
            jq -r '.name')
          
          if [[ ! "$SIGNOFF_NAME" =~ "success" ]]; then
            echo "Error: QA signoff was not successful"
            exit 1
          fi

      - name: Generate production version
        id: prod-version
        run: |
          # Remove prerelease suffix (e.g., 1.2.3-alpha.1 -> 1.2.3)
          PROD_VERSION=$(echo "${{ inputs.prerelease-version }}" | sed 's/-.*$//')
          echo "version=$PROD_VERSION" >> $GITHUB_OUTPUT
          echo "Production version: $PROD_VERSION"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Tag and push production Docker images
        run: |
          PROD_VERSION="${{ steps.prod-version.outputs.version }}"
          PRERELEASE_VERSION="${{ inputs.prerelease-version }}"
          
          # Monolith
          MONOLITH_COMMIT_IMAGE="${{ secrets.DOCKER_ORGANIZATION }}/modern-acceptance-testing-in-legacy-code-dotnet-monolith:commit-$PRERELEASE_VERSION"
          MONOLITH_PROD_IMAGE="${{ secrets.DOCKER_ORGANIZATION }}/modern-acceptance-testing-in-legacy-code-dotnet-monolith:$PROD_VERSION"
          MONOLITH_LATEST_IMAGE="${{ secrets.DOCKER_ORGANIZATION }}/modern-acceptance-testing-in-legacy-code-dotnet-monolith:latest"
          
          docker pull $MONOLITH_COMMIT_IMAGE
          docker tag $MONOLITH_COMMIT_IMAGE $MONOLITH_PROD_IMAGE
          docker tag $MONOLITH_COMMIT_IMAGE $MONOLITH_LATEST_IMAGE
          docker push $MONOLITH_PROD_IMAGE
          docker push $MONOLITH_LATEST_IMAGE

      - name: Deploy to production environment
        uses: ./.github/actions/deploy-docker-images
        with:
          monolith-image: ${{ secrets.DOCKER_ORGANIZATION }}/modern-acceptance-testing-in-legacy-code-dotnet-monolith:${{ steps.prod-version.outputs.version }}

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          sleep 30
          curl -f http://localhost:8080/echo || exit 1

      - name: Create production release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROD_VERSION="${{ steps.prod-version.outputs.version }}"
          
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/releases \
            -d "{
              \"tag_name\": \"v$PROD_VERSION\",
              \"name\": \"Production Release - $PROD_VERSION\",
              \"body\": \"ðŸš€ Production Release $PROD_VERSION\n\nPromoted from prerelease: ${{ inputs.prerelease-version }}\n\nDeployed by: ${{ github.actor }}\nDate: $(date -u +\"%Y-%m-%d %H:%M:%S UTC\")\n\nDocker Images:\n- Monolith: ${{ secrets.DOCKER_ORGANIZATION }}/modern-acceptance-testing-in-legacy-code-dotnet-monolith:$PROD_VERSION\",
              \"draft\": false,
              \"prerelease\": false
            }"

      - name: Display deployment info
        run: |
          echo "Successfully promoted to production"
          echo "Production version: ${{ steps.prod-version.outputs.version }}"
          echo "From prerelease: ${{ inputs.prerelease-version }}"
