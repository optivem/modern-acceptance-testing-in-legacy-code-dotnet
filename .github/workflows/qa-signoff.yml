name: QA Signoff

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to sign off (e.g., 1.2.3-alpha.1)'
        required: true
        type: string
      status:
        description: 'QA Status'
        required: true
        type: choice
        options:
          - success
          - failure
      comments:
        description: 'QA Comments'
        required: false
        type: string

jobs:
  qa-signoff:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if version exists
        run: |
          QA_TAG="qa-${{ inputs.version }}"
          RELEASE_EXISTS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$QA_TAG")
          
          if [ "$RELEASE_EXISTS" != "200" ]; then
            echo "Error: QA release $QA_TAG does not exist"
            exit 1
          fi

      - name: Create signoff release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          STATUS_EMOJI="${{ inputs.status == 'success' && '✅' || '❌' }}"
          RELEASE_BODY="QA Signoff: $STATUS_EMOJI ${{ inputs.status }}
          
          Version: ${{ inputs.version }}
          Signed off by: ${{ github.actor }}
          Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          Comments:
          ${{ inputs.comments || 'No comments provided' }}"
          
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/releases \
            -d "{
              \"tag_name\": \"qa-signoff-${{ inputs.version }}\",
              \"name\": \"QA Signoff - ${{ inputs.version }} (${{ inputs.status }})\",
              \"body\": $(echo "$RELEASE_BODY" | jq -Rs .),
              \"draft\": false,
              \"prerelease\": true
            }"

      - name: Update QA deployment release
        if: inputs.status == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          QA_TAG="qa-${{ inputs.version }}"
          RELEASE_ID=$(curl -s \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$QA_TAG" | \
            jq -r '.id')
          
          curl -X PATCH \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID" \
            -d '{
              "body": "✅ QA Approved\n\nSigned off by: ${{ github.actor }}\nReady for production deployment"
            }'

      - name: Display signoff info
        run: |
          echo "QA Signoff completed"
          echo "Version: ${{ inputs.version }}"
          echo "Status: ${{ inputs.status }}"
          echo "Signed off by: ${{ github.actor }}"
