name: QA Stage

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy to QA (e.g., 1.2.3-alpha.1)'
        required: true
        type: string

jobs:
  deploy-to-qa:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if prerelease exists
        id: check-release
        run: |
          RELEASE_EXISTS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/v${{ inputs.version }}")
          
          if [ "$RELEASE_EXISTS" != "200" ]; then
            echo "Error: Release v${{ inputs.version }} does not exist"
            exit 1
          fi
          
          # Check if it's a prerelease
          IS_PRERELEASE=$(curl -s \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/v${{ inputs.version }}" | \
            jq -r '.prerelease')
          
          if [ "$IS_PRERELEASE" != "true" ]; then
            echo "Error: Release v${{ inputs.version }} is not a prerelease"
            exit 1
          fi

      - name: Resolve Docker images
        id: resolve-images
        run: |
          MONOLITH_IMAGE="${{ secrets.DOCKER_ORGANIZATION }}/modern-acceptance-testing-in-legacy-code-dotnet-monolith:commit-${{ inputs.version }}"
          echo "monolith-image=$MONOLITH_IMAGE" >> $GITHUB_OUTPUT
          echo "Deploying monolith image: $MONOLITH_IMAGE"

      - name: Deploy to QA environment
        uses: ./.github/actions/deploy-docker-images
        with:
          monolith-image: ${{ steps.resolve-images.outputs.monolith-image }}

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          sleep 30
          curl -f http://localhost:8080/echo || exit 1

      - name: Create deployment release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/releases \
            -d '{
              "tag_name": "qa-${{ inputs.version }}",
              "name": "QA Deployment - ${{ inputs.version }}",
              "body": "Deployed version ${{ inputs.version }} to QA environment\n\nMonolith: ${{ steps.resolve-images.outputs.monolith-image }}",
              "draft": false,
              "prerelease": true
            }'

      - name: Display deployment info
        run: |
          echo "Successfully deployed to QA environment"
          echo "Version: ${{ inputs.version }}"
          echo "Monolith: ${{ steps.resolve-images.outputs.monolith-image }}"
